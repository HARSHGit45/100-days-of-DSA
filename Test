package com.imobile3.pos.data.module.batch.report

import com.imobile3.pos.app.AppLocaleHelper
import com.imobile3.pos.library.domainobjects.BatchReportDetailed
import com.imobile3.pos.library.utils.CurrencyManager
import io.mockk.every
import io.mockk.mockk
import io.mockk.mockkStatic
import io.mockk.unmockkAll
import org.junit.jupiter.api.AfterEach
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import java.math.BigDecimal
import java.math.RoundingMode
import kotlin.test.assertEquals

class BatchReportsHelperTest {

    private lateinit var mockCurrencyManager: CurrencyManager

    @BeforeEach
    fun setup() {
        // Mock static AppLocaleHelper.getCurrencyManager()
        mockkStatic(AppLocaleHelper::class)
        mockCurrencyManager = mockk(relaxed = true)

        every { AppLocaleHelper.getCurrencyManager() } returns mockCurrencyManager

        every { mockCurrencyManager.maxCalculationPrecision } returns 4
        every { mockCurrencyManager.roundingStyle } returns RoundingMode.HALF_UP
    }

    @AfterEach
    fun teardown() {
        unmockkAll()
    }

    // ---------------------------
    // calculateTotalPercentageSales
    // ---------------------------

    @Test
    fun `calculateTotalPercentageSales when grandTotal is null returns 0 percent`() {
        val report = BatchReportDetailed().apply {
            grandTotal = null
            tipTotal = BigDecimal("10.00")
        }

        val result = BatchReportsHelper.calculateTotalPercentageSales(report)

        assertEquals("0%", result)
    }

    @Test
    fun `calculateTotalPercentageSales when grandTotal is zero returns 0 percent`() {
        val report = BatchReportDetailed().apply {
            grandTotal = BigDecimal.ZERO
            tipTotal = BigDecimal("5.00")
        }

        val result = BatchReportsHelper.calculateTotalPercentageSales(report)

        assertEquals("0%", result)
    }

    @Test
    fun `calculateTotalPercentageSales when tipTotal is null returns 0 percent`() {
        val report = BatchReportDetailed().apply {
            grandTotal = BigDecimal("100.00")
            tipTotal = null
        }

        val result = BatchReportsHelper.calculateTotalPercentageSales(report)

        assertEquals("0%", result)
    }

    @Test
    fun `calculateTotalPercentageSales with valid totals returns correct percentage`() {
        val report = BatchReportDetailed().apply {
            grandTotal = BigDecimal("100.00")
            tipTotal = BigDecimal("10.00")
        }

        val result = BatchReportsHelper.calculateTotalPercentageSales(report)

        assertEquals("10%", result)
    }

    @Test
    fun `calculateTotalPercentageSales with tip greater than sales returns over 100 percent`() {
        val report = BatchReportDetailed().apply {
            grandTotal = BigDecimal("100.00")
            tipTotal = BigDecimal("150.00")
        }

        val result = BatchReportsHelper.calculateTotalPercentageSales(report)

        assertEquals("150%", result)
    }

    // ---------------------------
    // calculateTotalSales
    // ---------------------------

    @Test
    fun `calculateTotalSales when grandTotal is null returns 0`() {
        val report = BatchReportDetailed().apply {
            grandTotal = null
        }

        val result = BatchReportsHelper.calculateTotalSales(report)

        assertEquals("0", result)
    }

    @Test
    fun `calculateTotalSales with non-zero grandTotal formats correctly`() {
        val report = BatchReportDetailed().apply {
            grandTotal = BigDecimal("100.50")
        }

        val result = BatchReportsHelper.calculateTotalSales(report)

        assertEquals("100.50", result)
    }

    // ---------------------------
    // calculateNonCashTips
    // ---------------------------

    @Test
    fun `calculateNonCashTips when tipTotal is null returns 0`() {
        val report = BatchReportDetailed().apply {
            tipTotal = null
        }

        val result = BatchReportsHelper.calculateNonCashTips(report)

        assertEquals("0", result)
    }

    @Test
    fun `calculateNonCashTips with non-zero tipTotal formats correctly`() {
        val report = BatchReportDetailed().apply {
            tipTotal = BigDecimal("12.34")
        }

        val result = BatchReportsHelper.calculateNonCashTips(report)

        assertEquals("12.34", result)
    }
}                int startHour = 8 + random.nextInt(10); // between 8 AM - 6 PM
                int duration = 30 + random.nextInt(60); // 30-90 mins
                int endHour = Math.min(startHour + 1, 20);

                order.put("startTime", startHour + ":00 AM");
                order.put("endTime", endHour + ":00 AM");
                order.put("duration", duration + " min");

                // Customer details
                String customerName = firstNames[random.nextInt(firstNames.length)] + " " +
                                      lastNames[random.nextInt(lastNames.length)];
                order.put("customerName", customerName);
                order.put("phoneNo", "+1(" + (100 + random.nextInt(900)) + ") " + (100 + random.nextInt(900)) + "-" + (1000 + random.nextInt(9000)));

                // Tags
                order.put("statusTag", random.nextBoolean() ? "Completed" : "Pending");
                order.put("paymentTag", random.nextBoolean() ? "Paid" : "Unpaid");
                order.put("staffMember", staffMembers[random.nextInt(staffMembers.length)]);

                // Services
                List<Map<String, Object>> serviceList = new ArrayList<>();
                int numServices = 1 + random.nextInt(3); // 1–3 services
                int total = 0;

                for (int s = 0; s < numServices; s++) {
                    Map<String, Object> service = new HashMap<>();
                    String serviceName = services[random.nextInt(services.length)];
                    int price = prices[random.nextInt(prices.length)];
                    service.put("serviceName", serviceName);
                    service.put("price", price + "$");
                    serviceList.add(service);
                    total += price;
                }

                order.put("services", serviceList);
                order.put("total", total + "$");

                orders.add(order);
            }

            dateEntry.put("orders", orders);
            dateEntry.put("noOfOrders", orders.size());
            datesList.add(dateEntry);
        }

        jsonData.put("dates", datesList);

        // Write JSON to file
        ObjectMapper mapper = new ObjectMapper();
        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();
        writer.writeValue(new File("dummy_orders.json"), jsonData);

        System.out.println("✅ dummy_orders.json generated successfully!");
    }
}
