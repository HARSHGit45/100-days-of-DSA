#!/bin/bash
set -e

# ===================== Prerequisite Check =====================
command -v python3 >/dev/null 2>&1 || { echo >&2 "Python3 is required but not installed. Aborting."; exit 1; }
command -v ./gradlew >/dev/null 2>&1 || { echo >&2 "Gradle wrapper not found. Aborting."; exit 1; }

# ===================== Variables =====================
JACOCO_XML="build/reports/jacoco/tsysUnitedStatesDebugUnitTest/jacocoTestReport.xml"
OUTPUT_DIR="coverage_dashboard"
PYTHON_SCRIPT="coverage_report.py"
HTML_FILE="$OUTPUT_DIR/index.html"  # Assuming you put HTML file here

# ===================== Gradle Tasks =====================
echo "1️⃣ Cleaning project..."
./gradlew clean

echo "2️⃣ Running unit tests..."
./gradlew testTsysUnitedStatesDebugUnitTest

echo "3️⃣ Generating JaCoCo coverage..."
./gradlew jacocoTsysUnitedStatesDebugCoverage

# Check if XML exists
if [ ! -f "$JACOCO_XML" ]; then
    echo "❌ JaCoCo XML not found at $JACOCO_XML"
    exit 1
fi

# ===================== Generate CSV Reports =====================
echo "4️⃣ Generating CSV reports from JaCoCo XML..."
python3 $PYTHON_SCRIPT "$JACOCO_XML" "$OUTPUT_DIR"

# ===================== Launch HTML Dashboard =====================
echo "5️⃣ Opening HTML dashboard..."
if command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$HTML_FILE"
elif command -v open >/dev/null 2>&1; then
    open "$HTML_FILE"
else
    echo "⚠ Please open $HTML_FILE manually."
fi

echo "✅ Done!"
